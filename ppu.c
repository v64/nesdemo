#include <stdio.h>

#include "globals.h"
#include "constants.h"
#include "bits.h"
#include "memory.h"

#include "video.h"

// Taken from http://nesdev.parodius.com/nespal.txt
/*static unsigned char nes_palette[64][3] =
{
	{0x80,0x80,0x80}, {0x00,0x00,0xBB}, {0x37,0x00,0xBF}, {0x84,0x00,0xA6},
	{0xBB,0x00,0x6A}, {0xB7,0x00,0x1E}, {0xB3,0x00,0x00}, {0x91,0x26,0x00},
	{0x7B,0x2B,0x00}, {0x00,0x3E,0x00}, {0x00,0x48,0x0D}, {0x00,0x3C,0x22},
	{0x00,0x2F,0x66}, {0x00,0x00,0x00}, {0x05,0x05,0x05}, {0x05,0x05,0x05},

	{0xC8,0xC8,0xC8}, {0x00,0x59,0xFF}, {0x44,0x3C,0xFF}, {0xB7,0x33,0xCC},
	{0xFF,0x33,0xAA}, {0xFF,0x37,0x5E}, {0xFF,0x37,0x1A}, {0xD5,0x4B,0x00},
	{0xC4,0x62,0x00}, {0x3C,0x7B,0x00}, {0x1E,0x84,0x15}, {0x00,0x95,0x66},
	{0x00,0x84,0xC4}, {0x11,0x11,0x11}, {0x09,0x09,0x09}, {0x09,0x09,0x09},

	{0xFF,0xFF,0xFF}, {0x00,0x95,0xFF}, {0x6F,0x84,0xFF}, {0xD5,0x6F,0xFF},
	{0xFF,0x77,0xCC}, {0xFF,0x6F,0x99}, {0xFF,0x7B,0x59}, {0xFF,0x91,0x5F},
	{0xFF,0xA2,0x33}, {0xA6,0xBF,0x00}, {0x51,0xD9,0x6A}, {0x4D,0xD5,0xAE},
	{0x00,0xD9,0xFF}, {0x66,0x66,0x66}, {0x0D,0x0D,0x0D}, {0x0D,0x0D,0x0D},

	{0xFF,0xFF,0xFF}, {0x84,0xBF,0xFF}, {0xBB,0xBB,0xFF}, {0xD0,0xBB,0xFF},
	{0xFF,0xBF,0xEA}, {0xFF,0xBF,0xCC}, {0xFF,0xC4,0xB7}, {0xFF,0xCC,0xAE},
	{0xFF,0xD9,0xA2}, {0xCC,0xE1,0x99}, {0xAE,0xEE,0xB7}, {0xAA,0xF7,0xEE},
	{0xB3,0xEE,0xFF}, {0xDD,0xDD,0xDD}, {0x11,0x11,0x11}, {0x11,0x11,0x11}
};*/

static inline void draw_tile_scanline(unsigned char tile_num, int tile_pos, int current_scanline)
{
	unsigned short addr = tile_num * 16 + (BIT_IS_SET(PPU_CTRL_REG1, PPU_SCREEN_ADDR) ? CHR_ROM1 : CHR_ROM2);
	int j;
	for (j = 7; j >= 0; j--) {
		int result1 = ppu_memory[addr+(current_scanline % 8)]   & (1 << j);
		int result2 = ppu_memory[addr+(current_scanline % 8)+8] & (1 << j);
		int color;
		if ((result1 == 0) && (result2 == 0)) {
			color = 0x006666; // 0
		} else if ((result1 != 0) && (result2 == 0)) {
			color = 0xFFFFFF; // 1
		} else if ((result1 == 0) && (result2 != 0)) {
			color = 0x00FF00; // 2
		} else {
			color = 0x0000FF; // 3
		}
		draw_pixel((7-j) + (tile_pos*8), current_scanline, color);
	}
}

void draw_scanline(int current_scanline)
{
	if (!BIT_IS_SET(cpu_memory[PPU_CTRL_REG2], PPU_BACKGROUND_ENABLE))
		return;

	drawing_init();

	unsigned short addr;
	int result1 = cpu_memory[PPU_CTRL_REG1] & 0x01;
	int result2 = cpu_memory[PPU_CTRL_REG1] & 0x02;

	if ((result1 == 0) && (result2 == 0)) {
		addr = PPU_NAME_TABLE0;
	} else if ((result1 != 0) && (result2 == 0)) {
		addr = PPU_NAME_TABLE1;
	} else if ((result1 == 0) && (result2 != 0)) {
		addr = PPU_NAME_TABLE2;
	} else {
		addr = PPU_NAME_TABLE3;
	}

	int i;
	for (i = (current_scanline / 8)*32; i < (current_scanline / 8)*32 + 32; i++) {
		draw_tile_scanline(ppu_memory[addr+i], i % 32, current_scanline);
	}

	drawing_close(current_scanline);
}
